{% extends 'layout.html' %}
{% block content %}
<div class="position-sticky top-0 bg-white pb-2" style="z-index: 100;">
  <div class="d-flex align-items-center gap-3 pt-2">
    <h4 class="mb-0">设备 {{ device_id }}</h4>
    <span id="devStatus" class="badge text-bg-secondary">-</span>
    <span class="small text-muted" id="menuBrief">菜单 v-</span>
    <div class="ms-auto d-flex gap-2">
      <button class="btn btn-sm btn-outline-primary" onclick="sendSync()">同步</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="exportMenu()">导出菜单</button>
      <a class="btn btn-sm btn-outline-dark" href="/dispatch" target="_blank">打开下发中心</a>
    </div>
  </div>
</div>
<ul class="nav nav-tabs" id="devTabs">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-overview">概览</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-orders">订单</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-bins">料仓</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-commands">命令</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-alarms">告警</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-menu">菜单</a></li>
</ul>
<div class="tab-content mt-3">
  <div class="tab-pane fade show active" id="tab-overview">
    <div class="row g-3">
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-secondary">在线状态</div>
            <div class="fs-5 d-flex align-items-center gap-2">
              <span id="ov-status">-</span>
              <span id="ov-status-badge" class="badge text-bg-secondary">-</span>
            </div>
            <div class="small text-muted mt-1">最近在线：<span id="ov-last">-</span> <span id="ov-last-rel"></span></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-secondary">今日销量</div>
            <div class="fs-4 fw-semibold" id="ov-sales">-</div>
            <div class="small text-muted">来自订单计数</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-secondary">告警(Open)</div>
            <div class="fs-4 fw-semibold"><span id="ov-alarms">-</span></div>
            <div class="small text-muted">进行中的告警</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-secondary">低料仓</div>
            <div class="fs-4 fw-semibold"><span id="ov-bins-low">-</span></div>
            <div class="small text-muted">低于阈值的料仓数</div>
          </div>
        </div>
      </div>
    </div>
    <div class="row g-3 mt-1">
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-secondary">网络信息</div>
            <div class="small">IP: <span id="ov-ip">-</span></div>
            <div class="small">SSID: <span id="ov-ssid">-</span></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-secondary">菜单</div>
            <div class="small">版本: <span id="ov-menu-ver">-</span></div>
            <div class="small">分类数: <span id="ov-menu-cat">-</span> / 可售: <span id="ov-menu-avail">-</span></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="text-secondary">设备信息</div>
            <div class="small">固件: <span id="ov-fw">-</span></div>
            <div class="small">型号: <span id="ov-model">-</span></div>
            <div class="small">温度: <span id="ov-temp">-</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-pane fade" id="tab-orders">
    <div class="card mb-2"><div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label">时间范围</label>
          <div class="input-group input-group-sm">
            <input id="ordFrom" class="form-control" placeholder="起始(Unix秒，可留空)">
            <span class="input-group-text">至</span>
            <input id="ordTo" class="form-control" placeholder="结束(Unix秒，可留空)">
          </div>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">每页</label>
          <select id="ordPageSize" class="form-select form-select-sm">
            <option>20</option>
            <option selected>50</option>
            <option>100</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <button class="btn btn-sm btn-primary" onclick="loadOrders(1)">查询</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="exportOrders('csv')">导出CSV</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="exportOrders('json')">导出JSON</button>
        </div>
      </div>
    </div></div>
  <div class="table-responsive">
      <table class="table table-sm align-middle">
    <thead><tr id="ordThead"></tr></thead>
        <tbody id="ordTbody"></tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center">
      <div class="small text-muted" id="ordCount">-</div>
      <div>
        <button class="btn btn-sm btn-outline-secondary" onclick="ordPrev()">上一页</button>
        <span class="mx-2" id="ordPg">1/1</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="ordNext()">下一页</button>
      </div>
    </div>
  </div>
  <div class="tab-pane fade" id="tab-bins">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="text-secondary">料仓</div>
      <div>
        <button class="btn btn-sm btn-outline-secondary" onclick="loadBins()">刷新</button>
      </div>
    </div>
    <div id="binsGrid" class="row g-2"></div>
  </div>
  <div class="tab-pane fade" id="tab-commands">
    <button class="btn btn-sm btn-outline-primary" onclick="sendSync()">同步</button>
    <pre id="commands"></pre>
      <div class="card mb-2"><div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">命令类型</label>
            <select id="cmdType" class="form-select form-select-sm">
              <option value="sync">sync</option>
              <option value="menu_update">menu_update</option>
              <option value="upgrade">upgrade</option>
              <option value="open_door">open_door</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">载荷 JSON</label>
            <input id="cmdPayload" class="form-control form-control-sm" placeholder='{"force":true}'>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">备注</label>
            <input id="cmdNote" class="form-control form-control-sm" placeholder="可选">
          </div>
        </div>
        <div class="mt-2">
          <button class="btn btn-sm btn-primary" onclick="sendCmd()">发送命令</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="sendSync()">快速同步</button>
        </div>
      </div></div>
      <div class="card"><div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-secondary">命令列表</div>
          <div>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadCommands()">刷新</button>
            <div class="form-check form-check-inline ms-2">
              <input class="form-check-input" type="checkbox" id="autoRefresh" checked onchange="toggleCmdPolling(this.checked)">
              <label class="form-check-label" for="autoRefresh">自动刷新</label>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>编号</th><th>类型</th><th>状态</th><th>发出时间</th><th>回执时间</th><th>错误</th><th>操作</th></tr></thead>
            <tbody id="cmdTbody"></tbody>
          </table>
        </div>
      </div></div>
  </div>
  <div class="tab-pane fade" id="tab-alarms">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="text-secondary">告警</div>
      <button class="btn btn-sm btn-outline-secondary" onclick="loadAlarms()">刷新</button>
    </div>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead><tr><th>编号</th><th>严重程度</th><th>标题</th><th>状态</th><th>创建时间</th><th>更新时间</th><th>操作</th></tr></thead>
        <tbody id="alarmTbody"></tbody>
      </table>
    </div>
  </div>
  <div class="tab-pane fade" id="tab-menu">
    <div class="card mb-2">
      <div class="card-body d-flex flex-wrap align-items-center gap-2">
        <div>菜单版本：<span id="menuVer">-</span> / 状态：<span id="menuStatus">-</span></div>
        <button class="btn btn-sm btn-success" onclick="createCat()">新建分类</button>
        <button class="btn btn-sm btn-primary" onclick="publishMenu()">发布</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="exportMenu()">导出</button>
        <label class="btn btn-sm btn-outline-secondary mb-0">
          导入(覆盖)
          <input id="importOverwrite" type="file" accept="application/json" hidden onchange="importMenu('overwrite', this)">
        </label>
        <label class="btn btn-sm btn-outline-secondary mb-0">
          导入(合并)
          <input id="importMerge" type="file" accept="application/json" hidden onchange="importMenu('merge', this)">
        </label>
        <div class="ms-auto small text-muted">可售预览：<span id="availCount">-</span> 个</div>
      </div>
    </div>
    <div class="row g-2">
      <div class="col-md-4">
        <ul id="catList" class="list-group"></ul>
      </div>
      <div class="col-md-8">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
          <input id="menuSearch" class="form-control form-control-sm" placeholder="搜索名称/标签">
          <select id="menuVisFilter" class="form-select form-select-sm" style="width:auto">
            <option value="">全部</option>
            <option value="visible">显示</option>
            <option value="hidden">隐藏</option>
            <option value="archived">归档</option>
          </select>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="menuAvailOnly">
            <label class="form-check-label" for="menuAvailOnly">仅可售</label>
          </div>
          <div id="bulkBar" class="ms-auto d-none">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-success" onclick="bulkVisibility('visible')">批量上架</button>
              <button class="btn btn-outline-secondary" onclick="bulkVisibility('hidden')">批量下架</button>
              <button class="btn btn-outline-dark" onclick="bulkMoveCat()">批量移动</button>
              <button class="btn btn-outline-primary" onclick="bulkPriceAdjust()">批量调价</button>
              <button class="btn btn-outline-warning" onclick="bulkSetSchedule()">批量时段</button>
            </div>
          </div>
        </div>
        <div id="itemArea"></div>
      </div>
    </div>
  </div>
</div>
<script>
const deviceId = '{{ device_id }}'
let menuVer = null; // for If-Match
const base = {'X-Role':'admin','Content-Type':'application/json'}
const hdr = () => (menuVer ? {...base, 'If-Match': String(menuVer)} : base)

function refreshOverview(){
  fetch(`/api/v1/devices/${deviceId}/summary`,{headers:base}).then(r=>r.json()).then(x=>{
    const d = x.data||{}; const dv = d.device||{};
  const st = dv.status||'-';
  document.getElementById('ov-status').innerText = statusName(st)
  const badgeCls = (st==='online'?'text-bg-success':(st==='fault'?'text-bg-danger':(st==='maintenance'?'text-bg-warning':'text-bg-secondary')))
  document.getElementById('ov-status-badge').className = 'badge '+badgeCls
  document.getElementById('ov-status-badge').innerText = statusName(st)
  document.getElementById('devStatus').innerText = statusName(st)
  document.getElementById('devStatus').className = 'badge '+badgeCls
  document.getElementById('ov-last').innerText = tsfmt(dv.last_seen_ts)
  document.getElementById('ov-last-rel').innerText = dv.last_seen_ts? `(${tsrel(dv.last_seen_ts)})` : ''
  const t = (dv.temp_c||dv.temperature_c||dv.temperature)||''; document.getElementById('ov-temp').innerText = t!==''? (t+'℃') : '-'
  document.getElementById('ov-sales').innerText = (d.sales_today!=null? d.sales_today : '-')
  document.getElementById('ov-alarms').innerText = (d.alarms_open!=null? d.alarms_open : '-')
    document.getElementById('ov-ip').innerText = dv.ip||'-'
    document.getElementById('ov-ssid').innerText = dv.ssid||'-'
  document.getElementById('ov-fw').innerText = dv.fw_version||'-'
  document.getElementById('ov-model').innerText = dv.model||'-'
    const mm = (d.menu||{}).meta||{}; document.getElementById('ov-menu-ver').innerText = mm.version||'-'
  document.getElementById('ov-menu-cat').innerText = (d.menu||{}).category_count ?? '-'
    document.getElementById('ov-menu-avail').innerText = (d.menu||{}).available_count ?? '-'
    document.getElementById('menuBrief').innerText = `菜单 v${mm.version||'-'}`
  document.getElementById('ov-bins-low').innerText = d.bins_low_count ?? '-'
  })
}
let ordPage=1, ordTotal=0, ordPageSize=50, ordRows=[]
function ordSkeleton(){ document.getElementById('ordTbody').innerHTML = `<tr><td colspan="10"><div class="placeholder-glow"><span class="placeholder col-12" style="height:18px;display:block"></span></div></td></tr>` }
function ordCols(rows){ const set=new Set(); for(const r of rows){ for(const k of Object.keys(r||{})){ set.add(k) } } const preferred=['order_id','id','status','item','amount_cents','total_cents','pay_method','server_ts','device_ts']; const cols=[...preferred.filter(c=>set.has(c)), ...[...set].filter(c=>!preferred.includes(c)).sort()]; return cols }
function colName(c){ const map={order_id:'订单号',id:'编号',status:'状态',item:'商品',amount_cents:'金额(分)',total_cents:'总额(分)',pay_method:'支付方式',server_ts:'服务器时间',device_ts:'设备时间'}; if(map[c]) return map[c]; if(c.endsWith('_ts')) return '时间'; return c }
async function loadOrders(page){
  ordPage = page||1; ordPageSize = Number(document.getElementById('ordPageSize').value||50)
  const from = document.getElementById('ordFrom').value.trim(); const to = document.getElementById('ordTo').value.trim();
  ordSkeleton();
  const url = `/api/v1/devices/${deviceId}/orders?limit=${ordPageSize}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`
  const j = await fetch(url,{headers:base}).then(r=>r.json()); const rows = j.data||[]; ordRows = rows; ordTotal = rows.length; // server returns limited
  const cols = ordCols(rows); const thead=document.getElementById('ordThead'); thead.innerHTML = cols.map(c=>`<th>${colName(c)}</th>`).join('')
  const tbody=document.getElementById('ordTbody'); tbody.innerHTML='';
  const start=(ordPage-1)*ordPageSize, end=start+ordPageSize; const pageRows=rows.slice(start,end)
  for(const r of pageRows){ const tr=document.createElement('tr'); tr.innerHTML = cols.map(c=>`<td>${c.endsWith('_ts')? tsfmt(r[c]) : (r[c]??'')}</td>`).join(''); tbody.appendChild(tr) }
  const pages = Math.max(1, Math.ceil(ordTotal/ordPageSize)); document.getElementById('ordPg').innerText = `${ordPage}/${pages}`; document.getElementById('ordCount').innerText = `共 ${ordTotal} 条(最多返回${ordPageSize}条)`
}
function ordPrev(){ if(ordPage>1) loadOrders(ordPage-1) }
function ordNext(){ const pages=Math.max(1, Math.ceil(ordTotal/ordPageSize)); if(ordPage<pages) loadOrders(ordPage+1) }
async function exportOrders(fmt){ const from=document.getElementById('ordFrom').value.trim(); const to=document.getElementById('ordTo').value.trim(); const url = `/api/v1/devices/${deviceId}/orders/export?format=${fmt}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`; const resp = await fetch(url,{headers:base}); const blob = await resp.blob(); const a=document.createElement('a'); const ext=fmt==='json'?'json':'csv'; a.href=URL.createObjectURL(blob); a.download=`orders-${deviceId}.${ext}`; a.click(); URL.revokeObjectURL(a.href) }
async function loadBins(){
  try{
    const j = await fetch(`/api/v1/devices/${deviceId}/bins`,{headers:base}).then(r=>r.json());
    const list=j.data||[]; const grid=document.getElementById('binsGrid'); grid.innerHTML='';
    for(const b of list){
  const col=document.createElement('div'); col.className='col-12 col-sm-6 col-lg-4';
      const low = b.is_low; const pct = b.pct||0; const bar = low? 'bg-danger' : (pct<30?'bg-warning':'bg-success')
      col.innerHTML = `
        <div class="card h-100 ${low?'border-danger':''}">
          <div class="card-body">
    <div class="d-flex justify-content-between"><div class="fw-semibold">仓位 ${b.bin_index}</div>${low?'<span class="badge text-bg-danger">低料</span>':''}</div>
            <div class="text-muted small">${b.material_name||b.material_code||'-'}</div>
            <div class="mt-2">${b.remaining}/${b.capacity} ${b.unit||''}</div>
            <div class="progress mt-1" style="height:6px"><div class="progress-bar ${bar}" style="width:${pct}%"></div></div>
            <div class="small text-muted mt-1">阈值：${b.threshold_low_pct||'-'}%</div>
          </div>
        </div>`
      grid.appendChild(col)
    }
  }catch(e){}
}
async function loadAlarms(){
  try{
    const j = await fetch(`/api/v1/devices/${deviceId}/alarms`,{headers:base}).then(r=>r.json());
    const list=j.data||[]; const tb=document.getElementById('alarmTbody'); tb.innerHTML='';
    for(const a of list){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${a.id||''}</td>
    <td>${sevBadge(a.severity)}</td>
    <td>${a.title||''}</td>
    <td><span class="badge ${alarmStatusBadge(a.status)}">${statusCn(a.status)}</span></td>
        <td>${tsfmt(a.created_ts)}</td>
        <td>${tsfmt(a.updated_ts)}</td>
        <td>
          <div class="btn-group btn-group-sm">
      <button class="btn btn-outline-secondary" onclick="alarmSet('${a.id}','acked')">确认</button>
      <button class="btn btn-outline-success" onclick="alarmSet('${a.id}','closed')">关闭</button>
          </div>
        </td>`
      tb.appendChild(tr)
    }
  }catch(e){}
}
function sevBadge(s){ switch(s){case 'critical':return '<span class="badge text-bg-danger">严重</span>'; case 'warn': return '<span class="badge text-bg-warning">警告</span>'; default: return '<span class="badge text-bg-secondary">信息</span>'}}
function alarmStatusBadge(s){ switch(s){case 'open':return 'text-bg-danger'; case 'acked':return 'text-bg-warning'; case 'closed': return 'text-bg-success'; default: return 'text-bg-secondary'} }
function statusCn(s){ switch(s){case 'open': return '打开'; case 'acked': return '已确认'; case 'closed': return '已关闭'; default: return s||''} }
function statusName(s){ switch(s){case 'online': return '在线'; case 'fault': return '故障'; case 'maintenance': return '维护'; default: return '离线'} }
function alarmSet(id, st){ fetch(`/api/v1/devices/${deviceId}/alarms/${id}/status`,{method:'PATCH',headers:base,body:JSON.stringify({status:st})}).then(()=>{ cmToast('已更新告警','success'); loadAlarms() }) }

function safeJSON(s){try{return JSON.parse(s||'{}')}catch(e){return {}}}

async function loadMenu(){
  const resp = await fetch(`/api/v1/devices/${deviceId}/menu`,{headers:base});
  const {data} = await resp.json();
  window.menuData = data; 
  menuVer = (data.meta||{}).version; 
  document.getElementById('menuVer').innerText = menuVer||'-'; 
  document.getElementById('menuStatus').innerText = (data.meta||{}).status||'-';
  // availability
  try{
    const a = await fetch(`/api/v1/devices/${deviceId}/menu/available`,{headers:base}).then(r=>r.json());
    window.availSet = new Set(a.data||[]); document.getElementById('availCount').innerText = window.availSet.size||0
  }catch(e){ window.availSet = new Set(); document.getElementById('availCount').innerText = '-' }
  // categories
  const ul=document.getElementById('catList');ul.innerHTML='';
  (data.categories||[]).forEach((c,idx)=>{
    const name=(safeJSON(c.name_i18n_json).zh)||(`分类 ${c.id}`)
    const li=document.createElement('li');li.className='list-group-item';
    li.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <a href="javascript:void(0)" onclick="renderItems(${c.id})" class="text-decoration-none">${name}</a>
          ${c.visible==='0'?'<span class="badge text-bg-secondary ms-1">隐藏</span>':''}
        </div>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-secondary" title="上移" onclick="reorderCat(${idx},-1)">↑</button>
          <button class="btn btn-outline-secondary" title="下移" onclick="reorderCat(${idx},1)">↓</button>
          <button class="btn btn-outline-secondary" title="编辑" onclick="editCat(${c.id})">编</button>
          <button class="btn btn-outline-danger" title="删除" onclick="delCat(${c.id})">删</button>
        </div>
      </div>`
  li.setAttribute('draggable','true');
  li.dataset.index = String(idx);
  li.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', String(idx)); })
  li.addEventListener('dragover', (e)=>{ e.preventDefault(); li.classList.add('drag-over') })
  li.addEventListener('dragleave', ()=> li.classList.remove('drag-over'))
  li.addEventListener('drop', (e)=>{ e.preventDefault(); li.classList.remove('drag-over'); const from = Number(e.dataTransfer.getData('text/plain')); const to = Number(li.dataset.index); if(!Number.isNaN(from)&&!Number.isNaN(to)&&from!==to){ dndReorderCats(from,to) } })
  ul.appendChild(li)
  })
  if((data.categories||[])[0]) renderItems(data.categories[0].id)
}

function currentCat(){
  const id = window.currentCatId; if(!id) return null;
  return (window.menuData.categories||[]).find(x=>String(x.id)===String(id))||null
}

let menuSelected = new Set();
function updateBulkBar(){ const el=document.getElementById('bulkBar'); el.classList.toggle('d-none', menuSelected.size===0) }
function renderItems(catId){
  window.currentCatId = catId; 
  const cat = (window.menuData.categories||[]).find(x=>String(x.id)===String(catId)); if(!cat) return;
  const div=document.getElementById('itemArea');div.innerHTML='';
  const name=(safeJSON(cat.name_i18n_json).zh)||(`分类 ${cat.id}`)
  div.insertAdjacentHTML('beforeend',`
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">${name}</h5>
      <div><button class="btn btn-sm btn-outline-success" onclick="addItem(${cat.id})">新增商品</button></div>
    </div>`)
  const list=document.createElement('div');div.appendChild(list)
  // search & filter
  const q = (document.getElementById('menuSearch').value||'').trim().toLowerCase();
  const visFilter = document.getElementById('menuVisFilter').value||'';
  const availOnly = document.getElementById('menuAvailOnly').checked;
  let items = [...(cat.items||[])];
  if(q){ items = items.filter(it=>{ const nm=(safeJSON(it.name_i18n_json).zh||'').toLowerCase(); const tags=(it.tags_csv||'').toLowerCase(); return nm.includes(q)||tags.includes(q) }) }
  if(visFilter){ items = items.filter(it=> (it.visibility||'')===visFilter) }
  if(availOnly){ items = items.filter(it=> (window.availSet && window.availSet.has(String(it.id)))) }
  // render
  items.forEach((it,idx)=>{
    const nm=(safeJSON(it.name_i18n_json).zh)||(`商品 ${it.id}`)
    const vis=it.visibility||'visible'
    const price=it.price_cents_override||''
    const sch=(()=>{const x=safeJSON(it.schedule_json); return (x.ranges||[]).map(r=>r.join('-')).join(',')})()
    const avail = window.availSet && window.availSet.has(String(it.id))
    const card=document.createElement('div'); card.className='card p-2 mb-2';
    card.setAttribute('draggable','true'); card.dataset.index=String(idx); card.dataset.itemId=String(it.id)
    card.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', String(idx)); })
    card.addEventListener('dragover', (e)=>{ e.preventDefault(); card.classList.add('drag-over') })
    card.addEventListener('dragleave', ()=> card.classList.remove('drag-over'))
    card.addEventListener('drop', (e)=>{ e.preventDefault(); card.classList.remove('drag-over'); const from = Number(e.dataTransfer.getData('text/plain')); const to = Number(card.dataset.index); if(!Number.isNaN(from)&&!Number.isNaN(to)&&from!==to){ dndReorderItems(from,to) } })
    card.innerHTML=`
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold">
            <input class="form-check-input me-1" type="checkbox" ${menuSelected.has(String(it.id))?'checked':''} onclick="toggleSelect('${it.id}', this.checked)">
            ${nm} ${avail?'<span class="badge text-bg-success ms-1">可售</span>':''}
          </div>
          <div class="row g-2 mt-1">
            <div class="col-4">
              <label class="form-label form-label-sm">名称(zh)</label>
              <input class="form-control form-control-sm" value="${nm}" oninput="this.dataset.v=this.value" placeholder="名称">
            </div>
            <div class="col-3">
              <label class="form-label form-label-sm">价格(分)</label>
              <input class="form-control form-control-sm" value="${price}" oninput="this.dataset.v=this.value" placeholder="1800">
            </div>
            <div class="col-5">
              <label class="form-label form-label-sm">时段 HH:MM-HH:MM[,..]</label>
              <input class="form-control form-control-sm" value="${sch}" oninput="this.dataset.v=this.value" placeholder="08:00-11:00,13:00-17:00">
            </div>
          </div>
        </div>
        <div class="btn-group btn-group-sm">
          <select class="form-select form-select-sm" onchange="setVisibility(${it.id}, this.value)">
            ${['visible','hidden','archived'].map(v=>`<option value="${v}" ${v===vis?'selected':''}>${v}</option>`).join('')}
          </select>
          <button class="btn btn-outline-secondary" title="上移" onclick="reorderItem(${idx},-1)">↑</button>
          <button class="btn btn-outline-secondary" title="下移" onclick="reorderItem(${idx},1)">↓</button>
          <button class="btn btn-outline-secondary" title="编辑" onclick="openItemEditor(${it.id})">编</button>
          <button class="btn btn-outline-primary" onclick="saveItem(${it.id}, this)">保存</button>
          <button class="btn btn-outline-danger" onclick="delItem(${it.id})">删</button>
        </div>
      </div>`
    list.appendChild(card)
  })
  updateBulkBar()
  // wire filters
  document.getElementById('menuSearch').oninput = debounce(()=>renderItems(catId), 300)
  document.getElementById('menuVisFilter').onchange = ()=>renderItems(catId)
  document.getElementById('menuAvailOnly').onchange = ()=>renderItems(catId)
}

function createCat(){
  const name = prompt('分类中文名','推荐'); if(name==null) return;
  fetch(`/api/v1/devices/${deviceId}/menu/categories`,{method:'POST',headers:hdr(),body:JSON.stringify({name_i18n:{zh:name}})})
    .then(handleWrite).then(loadMenu)
}
function editCat(catId){
  const cat=(window.menuData.categories||[]).find(x=>String(x.id)===String(catId)); if(!cat) return;
  const cur=(safeJSON(cat.name_i18n_json).zh)||''; const name=prompt('分类中文名',cur); if(name===null) return;
  fetch(`/api/v1/devices/${deviceId}/menu/categories/${catId}`,{method:'PUT',headers:hdr(),body:JSON.stringify({name_i18n:{zh:name}})})
    .then(handleWrite).then(loadMenu)
}
async function delCat(catId){
  const ok = confirm('删除分类？若分类非空需指定目标分类ID进行迁移'); if(!ok) return;
  let url=`/api/v1/devices/${deviceId}/menu/categories/${catId}`
  const cat=(window.menuData.categories||[]).find(x=>String(x.id)===String(catId)); if(cat && (cat.items||[]).length){
    const target = prompt('请输入目标分类ID，用于迁移现有商品'); if(!target) return;
    url+=`?move_to=${encodeURIComponent(target)}`
  }
  fetch(url,{method:'DELETE',headers:hdr()})
    .then(handleWrite).then(loadMenu)
}
function reorderCat(idx, delta){
  const arr=[...(window.menuData.categories||[])]; const j=idx+delta; if(j<0||j>=arr.length) return;
  [arr[idx],arr[j]]=[arr[j],arr[idx]]; const body=arr.map((c,i)=>({cat_id:String(c.id),sort_order:i+1}))
  fetch(`/api/v1/devices/${deviceId}/menu/categories/reorder`,{method:'PATCH',headers:hdr(),body:JSON.stringify(body)})
    .then(handleWrite).then(loadMenu)
}
function dndReorderCats(from, to){ const arr=[...(window.menuData.categories||[])]; const moved=arr.splice(from,1)[0]; arr.splice(to,0,moved); const body=arr.map((c,i)=>({cat_id:String(c.id),sort_order:i+1})); fetch(`/api/v1/devices/${deviceId}/menu/categories/reorder`,{method:'PATCH',headers:hdr(),body:JSON.stringify(body)}).then(handleWrite).then(loadMenu) }
function addItem(catId){
  const name = prompt('商品中文名','拿铁'); if(name==null) return;
  const price = prompt('价格(分)','1800');
  fetch(`/api/v1/devices/${deviceId}/menu/items`,{method:'POST',headers:hdr(),body:JSON.stringify({cat_id:catId,recipe_id:'r-1',name_i18n:{zh:name},price_cents_override:price?Number(price):null})})
    .then(handleWrite).then(()=>renderItems(catId))
}
function saveItem(itemId, btn){
  const card = btn.closest('.card');
  const inputs = card.querySelectorAll('input.form-control-sm');
  const [nameI, priceI, schI] = inputs;
  const body = {};
  if(nameI && nameI.dataset.v!==undefined) body.name_i18n={zh:nameI.dataset.v}
  if(priceI && priceI.dataset.v!==undefined){ const v = priceI.dataset.v.trim(); body.price_cents_override = v? Number(v): null }
  if(schI && schI.dataset.v!==undefined){ const s=schI.dataset.v.trim(); body.schedule = s? {ranges: s.split(',').map(x=>x.trim()).filter(Boolean).map(x=>x.split('-'))} : {} }
  fetch(`/api/v1/devices/${deviceId}/menu/items/${itemId}`,{method:'PUT',headers:hdr(),body:JSON.stringify(body)})
    .then(handleWrite).then(()=>renderItems(window.currentCatId))
}
function setVisibility(itemId, vis){
  fetch(`/api/v1/devices/${deviceId}/menu/items/${itemId}/visibility`,{method:'PATCH',headers:hdr(),body:JSON.stringify({visibility:vis})})
    .then(handleWrite).then(()=>renderItems(window.currentCatId))
}
function reorderItem(idx, delta){
  const cat=currentCat(); if(!cat) return; const j=idx+delta; if(j<0||j>=cat.items.length) return;
  const arr=[...cat.items]; [arr[idx],arr[j]]=[arr[j],arr[idx]]; const body=arr.map((it,i)=>({item_id:String(it.id),sort_order:i+1}))
  fetch(`/api/v1/devices/${deviceId}/menu/categories/${cat.id}/reorder`,{method:'PATCH',headers:hdr(),body:JSON.stringify(body)})
    .then(handleWrite).then(()=>renderItems(cat.id))
}
function dndReorderItems(from, to){ const cat=currentCat(); if(!cat) return; const arr=[...cat.items]; const moved=arr.splice(from,1)[0]; arr.splice(to,0,moved); const body=arr.map((it,i)=>({item_id:String(it.id),sort_order:i+1})); fetch(`/api/v1/devices/${deviceId}/menu/categories/${cat.id}/reorder`,{method:'PATCH',headers:hdr(),body:JSON.stringify(body)}).then(handleWrite).then(()=>renderItems(cat.id)) }
function toggleSelect(id, on){ if(on){ menuSelected.add(String(id)) } else { menuSelected.delete(String(id)) } updateBulkBar() }
async function bulkVisibility(vis){ const ids=[...menuSelected]; if(!ids.length) return; for(const id of ids){ await fetch(`/api/v1/devices/${deviceId}/menu/items/${id}/visibility`,{method:'PATCH',headers:hdr(),body:JSON.stringify({visibility:vis})}) } cmToast('批量可视性已更新','success'); renderItems(window.currentCatId) }
async function bulkMoveCat(){ const target = prompt('目标分类ID'); if(!target) return; const ids=[...menuSelected]; for(const id of ids){ await fetch(`/api/v1/devices/${deviceId}/menu/items/${id}`,{method:'PUT',headers:hdr(),body:JSON.stringify({cat_id:String(target)})}) } cmToast('批量移动完成','success'); loadMenu() }
async function bulkPriceAdjust(){ const mode = prompt('输入绝对调价(如 +100 或 -200) 或 百分比(如 +10% 或 -5%)'); if(!mode) return; const ids=[...menuSelected]; for(const id of ids){ const h = (currentCat().items||[]).find(x=>String(x.id)===String(id))||{}; const cur = Number(h.price_cents_override||0); let val = cur; if(mode.endsWith('%')){ const p = parseFloat(mode); if(!Number.isNaN(p)) val = Math.round(cur*(1+p/100)) } else { const n = parseInt(mode); if(!Number.isNaN(n)) val = cur + n } await fetch(`/api/v1/devices/${deviceId}/menu/items/${id}/price`,{method:'PUT',headers:hdr(),body:JSON.stringify({price_cents_override: val})}) } cmToast('批量调价完成','success'); renderItems(window.currentCatId) }
async function bulkSetSchedule(){ const s = prompt('输入时段 HH:MM-HH:MM[,..]'); if(s===null) return; const sch = s? {ranges: s.split(',').map(x=>x.trim()).filter(Boolean).map(x=>x.split('-'))} : {}; const ids=[...menuSelected]; for(const id of ids){ await fetch(`/api/v1/devices/${deviceId}/menu/items/${id}/schedule`,{method:'PUT',headers:hdr(),body:JSON.stringify(sch)}) } cmToast('批量时段完成','success'); renderItems(window.currentCatId) }

// Offcanvas item editor
document.body.insertAdjacentHTML('beforeend',`
<div class="offcanvas offcanvas-end" tabindex="-1" id="itemEditor" aria-labelledby="itemEditorLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="itemEditorLabel">编辑商品</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="mb-2"><label class="form-label">名称(zh)</label><input id="edName" class="form-control"></div>
    <div class="mb-2"><label class="form-label">图片URL</label><input id="edImg" class="form-control"></div>
    <div class="mb-2"><label class="form-label">价格(分，留空继承)</label><input id="edPrice" class="form-control" placeholder="1800"></div>
    <div class="mb-2"><label class="form-label">角标(逗号分隔)</label><input id="edBadges" class="form-control" placeholder="新品,热销"></div>
    <div class="mb-2"><label class="form-label">标签(逗号分隔)</label><input id="edTags" class="form-control" placeholder="冰,加糖"></div>
    <div class="mb-2"><label class="form-label">时段 HH:MM-HH:MM[,..]</label><input id="edSchedule" class="form-control" placeholder="08:00-11:00,13:00-17:00"></div>
    <div class="text-end">
      <button class="btn btn-primary" onclick="saveItemFromEditor()">保存</button>
    </div>
  </div>
</div>`)
let edItemId=null; let itemEditor=null
function openItemEditor(id){ edItemId=String(id); const cat=currentCat(); const it=(cat.items||[]).find(x=>String(x.id)===edItemId)||{}; const nm=(safeJSON(it.name_i18n_json).zh)||''; const sch=(()=>{const x=safeJSON(it.schedule_json); return (x.ranges||[]).map(r=>r.join('-')).join(',')})(); document.getElementById('edName').value=nm; document.getElementById('edImg').value=it.image_url||''; document.getElementById('edPrice').value=it.price_cents_override||''; document.getElementById('edBadges').value=(it.badges_csv||''); document.getElementById('edTags').value=(it.tags_csv||''); document.getElementById('edSchedule').value=sch; if(!itemEditor){ itemEditor = new bootstrap.Offcanvas('#itemEditor') } itemEditor.show() }
function saveItemFromEditor(){ const body={}; const name=document.getElementById('edName').value.trim(); if(name!=='') body.name_i18n={zh:name}; const img=document.getElementById('edImg').value.trim(); body.image_url=img; const price=document.getElementById('edPrice').value.trim(); body.price_cents_override = price? Number(price): null; const badges=document.getElementById('edBadges').value.trim(); body.badges = badges? badges.split(',').map(x=>x.trim()).filter(Boolean): []; const tags=document.getElementById('edTags').value.trim(); body.tags = tags? tags.split(',').map(x=>x.trim()).filter(Boolean): []; const s=document.getElementById('edSchedule').value.trim(); body.schedule = s? {ranges: s.split(',').map(x=>x.trim()).filter(Boolean).map(x=>x.split('-'))}: {}; fetch(`/api/v1/devices/${deviceId}/menu/items/${edItemId}`,{method:'PUT',headers:hdr(),body:JSON.stringify(body)}).then(handleWrite).then(()=>{ itemEditor.hide(); renderItems(window.currentCatId) }) }
function delItem(itemId){
  fetch(`/api/v1/devices/${deviceId}/menu/items/${itemId}`,{method:'DELETE',headers:hdr()})
    .then(handleWrite).then(()=>renderItems(window.currentCatId))
}
function publishMenu(){
  fetch(`/api/v1/devices/${deviceId}/menu/publish`,{method:'POST',headers:hdr()})
    .then(handleWrite).then(loadMenu)
}
async function exportMenu(){
  const j = await fetch(`/api/v1/devices/${deviceId}/menu/export`,{headers:base}).then(r=>r.json());
  const blob = new Blob([JSON.stringify(j.data,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`menu-${deviceId}.json`; a.click(); URL.revokeObjectURL(a.href)
}
function importMenu(strategy, input){
  const file = input.files && input.files[0]; if(!file) return;
  const reader = new FileReader(); reader.onload = ()=>{
    try{ const json = JSON.parse(reader.result);
      fetch(`/api/v1/devices/${deviceId}/menu/import`,{method:'POST',headers:hdr(),body:JSON.stringify({strategy, menu_json: json})})
        .then(handleWrite).then(loadMenu)
    }catch(e){ alert('文件不是有效的JSON') }
    input.value=''
  }; reader.readAsText(file)
}
async function handleWrite(resp){
  if(!resp) return; 
  try{ const j = await resp.json(); 
    if(!j.ok){ 
      if(j.error==='CONFLICT'){ alert('版本冲突，已为你刷新菜单'); await loadMenu(); } 
      else { alert('操作失败：'+j.error) } 
    }
  }catch(e){}
}

function sendSync(){
  fetch(`/api/v1/devices/${deviceId}/commands`,{method:'POST',headers:base,body:JSON.stringify({type:'sync',payload:{}})})
    .then(r=>r.json()).then(x=>{cmToast('已下发 '+(x.data&&x.data.command_id),'success'); loadCommands()})
}

function sendCmd(){
  let payload={}; const raw=document.getElementById('cmdPayload').value.trim();
  if(raw){ try{ payload = JSON.parse(raw) }catch(e){ cmToast('Payload 不是合法 JSON','error'); return } }
  const type = document.getElementById('cmdType').value; const note=document.getElementById('cmdNote').value
  fetch(`/api/v1/devices/${deviceId}/commands`,{method:'POST',headers:base,body:JSON.stringify({type:type,payload:payload,note:note})})
    .then(r=>r.json()).then(x=>{ if(x.ok){ cmToast('下发成功: '+x.data.command_id,'success'); loadCommands() } else { cmToast('下发失败: '+x.error,'error') } })
}

let cmdTimer=null
function toggleCmdPolling(on){ if(cmdTimer){ clearInterval(cmdTimer); cmdTimer=null } if(on){ cmdTimer=setInterval(loadCommands, 3000) } }
async function loadCommands(){
  try{
    const j = await fetch(`/api/v1/devices/${deviceId}/commands?limit=100`,{headers:base}).then(r=>r.json());
    const list = j.data||[]; const tb=document.getElementById('cmdTbody'); tb.innerHTML='';
    for(const c of list){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="text-truncate" style="max-width:160px" title="${c.id}">${c.id}</td>
        <td>${c.type||''}</td>
        <td><span class="badge ${badgeByStatus(c.status)}">${c.status||''}</span></td>
        <td>${tsfmt(c.issued_ts)}</td>
        <td>${tsfmt(c.result_ts)}</td>
        <td class="text-danger">${c.last_error||''}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="copyPayload('${encodeURIComponent(c.payload_json||'{}')}')">复制payload</button>
            ${retryBtn(c)}
          </div>
        </td>
      `
      tb.appendChild(tr)
    }
  }catch(e){}
}
function badgeByStatus(s){
  switch(s){case 'success': return 'text-bg-success'; case 'fail': return 'text-bg-danger'; case 'sent': return 'text-bg-warning'; case 'pending': return 'text-bg-secondary'; default: return 'text-bg-light'}
}
function tsfmt(v){ if(!v) return ''; try{ const n=Number(v); if(!n) return ''; const d=new Date(n*1000); return d.toLocaleString() }catch{return ''} }
function tsrel(v){ if(!v) return ''; try{ const n=Number(v); if(!n) return ''; const diff = Math.floor(Date.now()/1000 - n); if(diff<60) return diff+'秒前'; if(diff<3600) return Math.floor(diff/60)+'分钟前'; if(diff<86400) return Math.floor(diff/3600)+'小时前'; return Math.floor(diff/86400)+'天前' }catch{return ''} }
function copyPayload(enc){ try{ const t = decodeURIComponent(enc); navigator.clipboard.writeText(t); cmToast('已复制','success') }catch{} }
function retryBtn(c){ if((c.status||'')!=='fail') return ''; const enc=encodeURIComponent(c.payload_json||'{}'); return `<button class="btn btn-outline-primary" onclick="retryCmd('${c.type||''}','${enc}')">重试</button>` }
function retryCmd(type, enc){ try{ const payload = JSON.parse(decodeURIComponent(enc)); fetch(`/api/v1/devices/${deviceId}/commands`,{method:'POST',headers:base,body:JSON.stringify({type, payload})}).then(()=>{ cmToast('已重试','success'); loadCommands() }) }catch{} }

refreshOverview();
loadOrders(1);
loadMenu();
// Auto refresh bins when its tab becomes active
document.querySelectorAll('#devTabs a[data-bs-toggle="tab"]').forEach(el=>{
  el.addEventListener('shown.bs.tab', (e)=>{
    const target = e.target.getAttribute('href');
    if(target === '#tab-bins') { loadBins() }
  })
})
</script>
{% endblock %}
