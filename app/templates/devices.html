{% extends 'layout.html' %}
{% block content %}
<h3>设备列表</h3>
<div class="card mb-2"><div class="card-body">
	<div class="row g-2">
		<div class="col-12 col-md-2">
			<select id="fStatus" class="form-select form-select-sm">
				<option value="">全部状态</option>
				<option value="online">online</option>
				<option value="offline">offline</option>
				<option value="fault">fault</option>
				<option value="maintenance">maintenance</option>
			</select>
		</div>
		<div class="col-12 col-md-4">
			<input id="fQuery" class="form-control form-control-sm" placeholder="输入设备ID/别名关键词">
		</div>
		<div class="col-12 col-md-3">
			<button class="btn btn-sm btn-primary" onclick="load(1)">查询</button>
			<button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">重置</button>
		</div>
		<div class="col-12 col-md-3 text-end">
			<div id="bulkBar" class="d-none btn-group btn-group-sm">
				<button class="btn btn-outline-primary" onclick="bulkSync()">批量同步</button>
				<button class="btn btn-outline-secondary" onclick="bulkMenuUpdate()">批量菜单更新</button>
			</div>
		</div>
	</div>
</div></div>

<div class="table-responsive">
	<table class="table table-sm align-middle">
		<thead>
			<tr>
				<th style="width:28px"><input class="form-check-input" type="checkbox" id="chkAll" onclick="toggleAll(this.checked)"></th>
				<th>设备ID</th>
				<th>别名</th>
				<th>状态</th>
				<th>固件</th>
				<th>Last Seen</th>
				<th></th>
			</tr>
		</thead>
		<tbody id="tb"></tbody>
	</table>
</div>
<div class="d-flex justify-content-between align-items-center">
	<div class="small text-muted" id="countText">-</div>
	<div>
		<button class="btn btn-sm btn-outline-secondary" onclick="prevPage()">上一页</button>
		<span class="mx-2" id="pgText">1/1</span>
		<button class="btn btn-sm btn-outline-secondary" onclick="nextPage()">下一页</button>
	</div>
	<div>
		<select id="pgSize" class="form-select form-select-sm" style="width:auto;display:inline-block" onchange="load(1)">
			<option value="10">10</option>
			<option value="20" selected>20</option>
			<option value="50">50</option>
		</select>
	</div>
</div>

<script>
let curPage=1, total=0, pageSize=20, list=[]; let selected=new Set()
function resetFilters(){ document.getElementById('fStatus').value=''; document.getElementById('fQuery').value=''; load(1) }
function tsRel(ts){ if(!ts) return '-'; try{ const n=Number(ts); if(!n) return '-'; const diff = Math.floor(Date.now()/1000 - n); if(diff<60) return diff+'秒前'; if(diff<3600) return Math.floor(diff/60)+'分钟前'; if(diff<86400) return Math.floor(diff/3600)+'小时前'; return Math.floor(diff/86400)+'天前' }catch{return '-'} }
function badgeByStatus(s){ switch(s){case 'online':return 'text-bg-success'; case 'fault':return 'text-bg-danger'; case 'maintenance':return 'text-bg-warning'; default:return 'text-bg-secondary'} }
function updateBulkBar(){ document.getElementById('bulkBar').classList.toggle('d-none', selected.size===0) }
function toggleAll(on){ const cb = document.querySelectorAll('.rowChk'); cb.forEach(x=>{ x.checked=on; if(on) selected.add(x.value); else selected.delete(x.value) }); updateBulkBar() }
function toggleOne(el){ if(el.checked) selected.add(el.value); else selected.delete(el.value); updateBulkBar() }
async function load(page){
	curPage = page||1; pageSize = Number(document.getElementById('pgSize').value||20)
	const status = document.getElementById('fStatus').value||''
	const query = document.getElementById('fQuery').value||''
	document.getElementById('tb').innerHTML = `<tr><td colspan="7"><div class="placeholder-glow"><span class="placeholder col-12" style="height:18px;display:block"></span></div></td></tr>`
	const url = `/api/v1/devices?status=${encodeURIComponent(status)}&query=${encodeURIComponent(query)}&page=${curPage}&page_size=${pageSize}`
	const j = await fetch(url,{headers:{'X-Role':'admin'}}).then(r=>r.json());
	const data = j.data||{items:[], total:0, page:1, page_size:pageSize}; list = data.items||[]; total=data.total||0
	const tb=document.getElementById('tb'); tb.innerHTML=''
	for(const d of list){
		const tr=document.createElement('tr');
		tr.innerHTML = `
			<td><input class="form-check-input rowChk" type="checkbox" value="${d.device_id}" onclick="toggleOne(this)"></td>
			<td><a href="/devices/${d.device_id}">${d.device_id}</a></td>
			<td>${d.alias||''}</td>
			<td><span class="badge ${badgeByStatus(d.status)}">${d.status||''}</span></td>
			<td>${d.fw_version||''}</td>
			<td>${tsRel(d.last_seen_ts)}</td>
			<td>
				<div class="btn-group btn-group-sm">
					<a class="btn btn-outline-secondary" href="/devices/${d.device_id}">详情</a>
					<button class="btn btn-outline-primary" onclick="sendCmd('${d.device_id}','sync')">sync</button>
					<button class="btn btn-outline-secondary" onclick="sendCmd('${d.device_id}','menu_update')">menu_update</button>
				</div>
			</td>
		`
		tb.appendChild(tr)
	}
	const pages = Math.max(1, Math.ceil(total/pageSize)); document.getElementById('pgText').innerText = `${curPage}/${pages}`
	document.getElementById('countText').innerText = `共 ${total} 台设备`
}
function prevPage(){ if(curPage>1){ load(curPage-1) } }
function nextPage(){ const pages = Math.max(1, Math.ceil(total/pageSize)); if(curPage<pages){ load(curPage+1) } }
function sendCmd(did, type){ fetch(`/api/v1/devices/${did}/commands`,{method:'POST',headers:{'X-Role':'admin','Content-Type':'application/json'},body:JSON.stringify({type,payload:{}})}).then(()=>cmToast('已下发: '+type,'success')) }
async function bulkSync(){ const ids=[...selected]; for(const id of ids){ await fetch(`/api/v1/devices/${id}/commands`,{method:'POST',headers:{'X-Role':'admin','Content-Type':'application/json'},body:JSON.stringify({type:'sync',payload:{}})}) } cmToast('批量同步已下发','success') }
async function bulkMenuUpdate(){ const ids=[...selected]; for(const id of ids){ await fetch(`/api/v1/devices/${id}/commands`,{method:'POST',headers:{'X-Role':'admin','Content-Type':'application/json'},body:JSON.stringify({type:'menu_update',payload:{}})}) } cmToast('批量菜单更新已下发','success') }
load(1)
</script>
{% endblock %}
