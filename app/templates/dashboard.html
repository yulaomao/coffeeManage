{% extends 'layout.html' %}
{% block content %}
<h3 class="mb-3">仪表盘</h3>

<div id="dash-alert" class="alert alert-info d-none">加载中…</div>
<div id="dash-error" class="alert alert-danger d-none"></div>

<div class="row g-3">
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-3 text-primary"><svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></div>
          <div>
            <div class="text-secondary">设备数</div>
            <div class="fs-4 fw-semibold" id="kpi-device">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-3 text-success"><svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a8 8 0 1 0 8 8h-2a6 6 0 1 1-6-6V4z"/></svg></div>
          <div class="w-100">
            <div class="d-flex justify-content-between"><span class="text-secondary">在线率</span><span id="kpi-online-text">-</span></div>
            <div class="progress" style="height:6px"><div id="kpi-online" class="progress-bar" role="progressbar" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-3 text-warning"><svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg></div>
          <div>
            <div class="text-secondary">今日销量</div>
            <div class="fs-4 fw-semibold" id="kpi-sales">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="me-3 text-danger"><svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>
          <div>
            <div class="text-secondary">开放告警</div>
            <div class="fs-4 fw-semibold" id="kpi-alarms">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-12 col-lg-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-secondary mb-1">低料设备</div>
        <div class="fs-5" id="kpi-low">-</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-secondary mb-1">待处理命令</div>
        <div class="fs-5" id="kpi-cmd">-</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-secondary mb-1">24h 菜单发布</div>
        <div class="fs-5" id="kpi-publish">-</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-secondary">近7日销量</div>
          <small class="text-muted" id="sales-sum">-</small>
        </div>
        <canvas id="chart-sales" height="120"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="text-secondary mb-2">活跃设备（近7天）</div>
        <canvas id="chart-active" height="120"></canvas>
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-secondary mb-2">在线率</div>
        <canvas id="chart-online" height="120"></canvas>
      </div>
    </div>
  </div>
  
</div>

<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-secondary">低料设备详情</div>
          <a class="small text-decoration-none" href="/devices">前往设备列表</a>
        </div>
        <div id="low-empty" class="text-muted d-none">全部设备料仓充足，无低料告警。</div>
        <div id="low-list" class="list-group list-group-flush"></div>
      </div>
    </div>
  </div>
  
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const hdr={'X-Role':'admin'}
const $=(id)=>document.getElementById(id)
function showLoading(flag){
  $('dash-alert').classList.toggle('d-none', !flag)
}
function showError(msg){
  const el=$('dash-error'); el.classList.toggle('d-none', !msg); if(msg) el.innerText=msg
}
async function load(){
  showLoading(true); showError('')
  try{
    const r = await fetch('/api/v1/dashboard/summary',{headers:hdr});
    const j = await r.json();
    const d = j.data||{};
    $('kpi-device').innerText = d.device_total ?? '-'
    const rate = Number(d.online_rate||0)
    $('kpi-online').style.width = rate+'%'
    $('kpi-online-text').innerText = isNaN(rate)?'-':(rate+'%')
    $('kpi-sales').innerText = d.sales_today ?? '-'
    $('kpi-alarms').innerText = d.alarms_open ?? '-'
    $('kpi-low').innerText = d.low_material_devices ?? '-'
    $('kpi-cmd').innerText = d.pending_commands_count ?? '-'
    $('kpi-publish').innerText = d.menu_published_today ?? '-'
  }catch(e){
    showError('加载失败：'+e)
  }finally{
    showLoading(false)
  }
}
async function loadTrends(){
  try{
    const r = await fetch('/api/v1/dashboard/trends?days=7',{headers:hdr});
    const j = await r.json(); const t=j.data||{};
    const labels=t.days||[]; const sales=t.sales||[]; const active=t.active_devices||[];
    $('sales-sum').innerText = '合计：'+(sales.reduce((a,b)=>a+b,0)||0)
    // sales line
    new Chart($('chart-sales'),{type:'line',data:{labels,datasets:[{label:'销量',data:sales,borderColor:'#0d6efd',backgroundColor:'rgba(13,110,253,.15)',fill:true,tension:.3}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}})
    // active bar
    new Chart($('chart-active'),{type:'bar',data:{labels,datasets:[{label:'活跃设备',data:active,backgroundColor:'#198754'}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}})
    // online doughnut uses summary loaded earlier
    const text = $('kpi-online-text').innerText.replace('%','')
    const rate = Number(text)||0
    new Chart($('chart-online'),{type:'doughnut',data:{labels:['在线','离线'],datasets:[{data:[rate,100-rate],backgroundColor:['#20c997','#dee2e6']}]},options:{cutout:'70%',plugins:{legend:{display:false}}}})
  }catch(e){/* ignore charts error */}
}
async function loadLow(){
  try{
    const r = await fetch('/api/v1/dashboard/low-materials?limit=12',{headers:hdr});
    const j = await r.json(); const list = j.data||[];
    const wrap = $('low-list'); wrap.innerHTML='';
    if(!list.length){ $('low-empty').classList.remove('d-none'); return }
    $('low-empty').classList.add('d-none');
    for(const d of list){
      const dev = document.createElement('a');
      dev.className='list-group-item list-group-item-action';
      dev.href = `/devices/${encodeURIComponent(d.device_id)}`;
      const name = (d.alias&&d.alias.trim())?`${d.alias}（${d.device_id}）`:d.device_id;
      const badge = `<span class="badge rounded-pill text-bg-danger ms-2">${d.low_count}</span>`;
      let bins = '';
      for(const b of (d.bins||[])){
        const level = (b.pct<=10)?'danger':(b.pct<=30?'warning':'secondary');
        bins += `<span class="badge text-bg-${level} me-2 mb-1">${b.material_name} ${b.pct}%</span>`
      }
      dev.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">${name}${badge}</div>
          <small class="text-muted">点击查看设备</small>
        </div>
        <div class="mt-2">${bins}</div>
      `;
      wrap.appendChild(dev);
    }
  }catch(e){ /* non-blocking */ }
}
load(); loadTrends(); loadLow();
</script>
{% endblock %}
