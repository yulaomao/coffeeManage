{% extends 'layout.html' %}
{% block content %}

<!-- Cyber Dashboard Header -->
<div class="position-sticky top-0 pb-3" style="z-index:100;">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-3">
      <h3 class="mb-0 fw-bold">指挥中心</h3>
      <span class="status-dot online"></span>
      <small class="text-muted">实时连接</small>
    </div>
    
    <!-- Role Selector -->
    <div class="d-flex align-items-center gap-3">
      <div class="btn-group btn-group-sm" role="group" aria-label="角色切换">
        <input type="radio" class="btn-check" name="roleSwitch" id="roleOps" value="ops" checked>
        <label class="btn btn-outline-primary" for="roleOps">Ops</label>
        <input type="radio" class="btn-check" name="roleSwitch" id="roleBiz" value="biz">
        <label class="btn btn-outline-primary" for="roleBiz">Biz</label>
        <input type="radio" class="btn-check" name="roleSwitch" id="roleEng" value="eng">
        <label class="btn btn-outline-primary" for="roleEng">Eng</label>
      </div>
      
      <!-- Quick Actions -->
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" onclick="exportSummary()" aria-label="导出指标">
          <i class="bi bi-download"></i>
        </button>
        <button class="btn btn-sm btn-outline-primary" onclick="commandPanel.open()" aria-label="命令面板">
          <i class="bi bi-command"></i>
        </button>
        <a class="btn btn-sm btn-outline-primary" href="/dispatch" aria-label="前往下发中心">
          <i class="bi bi-rocket"></i>
        </a>
      </div>
    </div>
  </div>

  <!-- Time Range Controls -->
  <div class="filterbar">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label class="form-label fw-semibold">时间窗口</label>
        <div class="d-flex gap-2 flex-wrap">
          <div class="btn-group btn-group-sm" role="group">
            <button id="btnToday" class="btn btn-outline-secondary" onclick="setRange('today')">Today</button>
            <button id="btn7d" class="btn btn-outline-secondary" onclick="setRange('7d')">7d</button>
            <button id="btn30d" class="btn btn-outline-secondary" onclick="setRange('30d')">30d</button>
          </div>
          <div class="input-group input-group-sm" style="max-width:300px">
            <input id="fltFrom" class="form-control" placeholder="From (Unix)">
            <input id="fltTo" class="form-control" placeholder="To (Unix)">
          </div>
        </div>
      </div>
      <div class="col-md-6 text-end">
        <button class="btn btn-primary btn-sm" onclick="reloadAll()">
          <i class="bi bi-arrow-clockwise me-1"></i>刷新
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="resetRange()">重置</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading & Error States -->
<div id="dash-alert" class="alert alert-info d-none">
  <div class="d-flex align-items-center">
    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
    数据加载中...
  </div>
</div>
<div id="dash-error" class="alert alert-danger d-none"></div>

<!-- Main Dashboard Grid -->
<div class="dashboard-grid">
  
  <!-- 1. KPI Bridge Panel (Full Width) -->
  <div class="dashboard-panel panel-full" id="kpi-bridge-panel">
    <div class="panel-header">
      <h5 class="panel-title">核心指标舰桥</h5>
      <div class="panel-controls">
        <button class="panel-control-btn" title="设置"><i class="bi bi-gear"></i></button>
      </div>
    </div>
    <div class="kpi-bridge">
      <div class="kpi-item">
        <div class="kpi-value" id="kpi-device">-</div>
        <div class="kpi-label">设备在线</div>
        <div class="kpi-sparkline" id="device-sparkline"></div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value" id="kpi-revenue">-</div>
        <div class="kpi-label">今日营收</div>
        <div class="kpi-sparkline" id="revenue-sparkline"></div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value" id="kpi-orders">-</div>
        <div class="kpi-label">今日杯数</div>
        <div class="kpi-sparkline" id="orders-sparkline"></div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value" id="kpi-cmd-fail">-</div>
        <div class="kpi-label">命令失败率</div>
        <div class="kpi-sparkline" id="cmd-fail-sparkline"></div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value" id="kpi-low">-</div>
        <div class="kpi-label">低料设备</div>
        <div class="kpi-sparkline" id="low-sparkline"></div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value" id="kpi-alarms">-</div>
        <div class="kpi-label">开放告警</div>
        <div class="kpi-sparkline" id="alarms-sparkline"></div>
      </div>
    </div>
  </div>

  <!-- 2. Device Health Star Map -->
  <div class="dashboard-panel panel-large" id="device-starmap-panel">
    <div class="panel-header">
      <h5 class="panel-title">设备健康星图</h5>
      <div class="panel-controls">
        <button class="panel-control-btn" title="全屏"><i class="bi bi-arrows-fullscreen"></i></button>
        <button class="panel-control-btn" title="设置"><i class="bi bi-gear"></i></button>
      </div>
    </div>
    <div class="device-starmap" id="device-starmap">
      <!-- Device points will be dynamically generated -->
    </div>
  </div>

  <!-- 3. Real-time Order & Revenue Flow -->
  <div class="dashboard-panel panel-large" id="realtime-flow-panel">
    <div class="panel-header">
      <h5 class="panel-title">实时订单营收流</h5>
      <div class="panel-controls">
        <button class="panel-control-btn" title="暂停"><i class="bi bi-pause"></i></button>
        <button class="panel-control-btn" title="设置"><i class="bi bi-gear"></i></button>
      </div>
    </div>
    <div class="realtime-flow" id="realtime-flow">
      <canvas id="realtime-chart" width="100%" height="200"></canvas>
    </div>
  </div>

  <!-- 4. Menu Heatmap & Funnel -->
  <div class="dashboard-panel panel-tall" id="menu-heatmap-panel">
    <div class="panel-header">
      <h5 class="panel-title">菜单热力漏斗</h5>
      <div class="panel-controls">
        <button class="panel-control-btn" title="切换视图"><i class="bi bi-grid-3x3"></i></button>
        <button class="panel-control-btn" title="设置"><i class="bi bi-gear"></i></button>
      </div>
    </div>
    <div class="menu-heatmap">
      <div class="heatmap-matrix" id="heatmap-matrix">
        <!-- Heatmap cells will be generated dynamically -->
      </div>
      <div class="conversion-funnel" id="conversion-funnel">
        <div class="funnel-stage">
          <div class="fw-semibold">浏览</div>
          <div class="text-muted small">1,234 次</div>
        </div>
        <div class="funnel-stage">
          <div class="fw-semibold">加购</div>
          <div class="text-muted small">856 次</div>
        </div>
        <div class="funnel-stage">
          <div class="fw-semibold">支付</div>
          <div class="text-muted small">789 次</div>
        </div>
        <div class="funnel-stage">
          <div class="fw-semibold">制作</div>
          <div class="text-muted small">756 次</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 5. Materials Radar -->
  <div class="dashboard-panel panel-medium" id="materials-radar-panel">
    <div class="panel-header">
      <h5 class="panel-title">物料补货雷达</h5>
      <div class="panel-controls">
        <button class="panel-control-btn" title="生成补货单"><i class="bi bi-plus-circle"></i></button>
        <button class="panel-control-btn" title="设置"><i class="bi bi-gear"></i></button>
      </div>
    </div>
    <div class="materials-radar">
      <div class="radar-chart" id="materials-radar-chart"></div>
      <div class="materials-list" id="materials-list">
        <!-- Material items will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- 6. Command & Dispatch Center -->
  <div class="dashboard-panel panel-tall" id="command-center-panel">
    <div class="panel-header">
      <h5 class="panel-title">命令指挥台</h5>
      <div class="panel-controls">
        <button class="panel-control-btn" title="新建批次"><i class="bi bi-plus"></i></button>
        <button class="panel-control-btn" title="设置"><i class="bi bi-gear"></i></button>
      </div>
    </div>
    <div class="command-center">
      <div class="command-header">
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" onclick="createNewBatch()">
            <i class="bi bi-lightning me-1"></i>新建批次
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="refreshBatches()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
      <div class="command-list" id="command-batches">
        <!-- Command batches will be loaded dynamically -->
      </div>
    </div>
  </div>

</div>

<!-- Enhanced JavaScript -->
<script>
// Dashboard configuration
const dashboardConfig = {
  role: 'ops', // ops, biz, eng
  refreshInterval: 15000, // 15 seconds
  realtimeEnabled: true
};

// Global variables for existing compatibility
let curRange = '7d';
const hdr = {'Content-Type': 'application/json'};
const $ = (id) => document.getElementById(id);

// Enhanced dashboard functions
function setRange(range) {
  curRange = range;
  ['btnToday', 'btn7d', 'btn30d'].forEach(id => {
    $(id).classList.remove('active');
  });
  $('btn' + (range === 'today' ? 'Today' : range)).classList.add('active');
  applyRangeInputs();
}

function getRange() {
  const now = Math.floor(Date.now() / 1000);
  if (curRange === 'today') {
    const todayStart = Math.floor(new Date().setHours(0,0,0,0) / 1000);
    return {from: todayStart, to: now};
  }
  if (curRange === '30d') return {from: now - 30*86400, to: now};
  return {from: now - 7*86400, to: now};
}

function applyRangeInputs() {
  const r = getRange();
  $('fltFrom').value = String(r.from);
  $('fltTo').value = String(r.to);
}

function reloadAll() {
  load();
  loadTrends();
  loadLow();
  loadBatches();
  loadOrdersKPI();
  updateDeviceStarmap();
  updateMaterialsRadar();
}

function showLoading(flag) {
  $('dash-alert').classList.toggle('d-none', !flag);
}

function showError(msg) {
  const el = $('dash-error');
  el.classList.toggle('d-none', !msg);
  if (msg) el.innerText = msg;
}

// Enhanced KPI loading with sparklines
async function load() {
  showLoading(true);
  showError('');
  try {
    const r = await fetch('/api/v1/dashboard/summary', {headers: hdr});
    const j = await r.json();
    const d = j.data || {};
    
    // Update KPI values with animations
    updateKPI('kpi-device', d.device_total ?? '-');
    updateKPI('kpi-alarms', d.alarms_open ?? '-');
    updateKPI('kpi-low', d.low_material_devices ?? '-');
    updateKPI('kpi-cmd-fail', ((d.failed_commands || 0) / Math.max(d.total_commands || 1, 1) * 100).toFixed(1) + '%');
    
  } catch(e) {
    showError('加载失败：' + e);
  } finally {
    showLoading(false);
  }
}

function updateKPI(elementId, value) {
  const element = $(elementId);
  if (element && element.textContent !== value) {
    element.style.transform = 'scale(1.1)';
    element.textContent = value;
    setTimeout(() => {
      element.style.transform = 'scale(1)';
    }, 200);
  }
}

// Device starmap visualization
function updateDeviceStarmap() {
  const starmap = $('device-starmap');
  // This would integrate with actual device data
  // For now, showing placeholder structure
}

// Materials radar update
function updateMaterialsRadar() {
  const materialsList = $('materials-list');
  // Load materials data and update radar chart
}

// Batch operations
async function loadBatches() {
  try {
    const r = await fetch('/api/v1/commands/batches?limit=5', {headers: hdr});
    const j = await r.json();
    const data = j.data || {};
    const batches = data.items || []; // Fix: handle the proper data structure
    
    const container = $('command-batches');
    if (!container) return;
    
    container.innerHTML = '';
    
    batches.forEach(batch => {
      const batchElement = createBatchElement(batch);
      container.appendChild(batchElement);
    });
    
    // Show placeholder if no batches
    if (batches.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
          <div>暂无命令批次</div>
          <small>点击"新建批次"开始</small>
        </div>
      `;
    }
  } catch(e) {
    console.error('Failed to load batches:', e);
    const container = $('command-batches');
    if (container) {
      container.innerHTML = `
        <div class="text-center text-danger py-4">
          <i class="bi bi-exclamation-triangle fs-1 mb-2 d-block"></i>
          <div>加载失败</div>
          <small>${e.message}</small>
        </div>
      `;
    }
  }
}

function createBatchElement(batch) {
  const div = document.createElement('div');
  div.className = 'command-batch';
  div.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">${batch.name || batch.id}</div>
      <span class="status-dot ${batch.status || 'processing'}"></span>
    </div>
    <div class="batch-progress">
      <div class="batch-progress-fill" style="width: ${batch.progress || 0}%"></div>
    </div>
    <div class="small text-muted mt-1">
      ${batch.completed || 0}/${batch.total || 0} 完成
    </div>
  `;
  
  div.addEventListener('click', () => {
    window.location.href = `/dispatch/${batch.id}`;
  });
  
  return div;
}

// Role switching
document.addEventListener('DOMContentLoaded', () => {
  // Initialize role switching
  document.querySelectorAll('input[name="roleSwitch"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      dashboardConfig.role = e.target.value;
      applyRoleView(e.target.value);
    });
  });
  
  // Initialize dashboard
  setRange('7d');
  reloadAll();
  
  // Start real-time updates
  if (dashboardConfig.realtimeEnabled) {
    setInterval(reloadAll, dashboardConfig.refreshInterval);
  }
});

function applyRoleView(role) {
  // Hide/show panels based on role
  const panels = document.querySelectorAll('.dashboard-panel');
  panels.forEach(panel => {
    panel.style.display = shouldShowPanelForRole(panel.id, role) ? 'block' : 'none';
  });
}

function shouldShowPanelForRole(panelId, role) {
  // Define which panels to show for each role
  const rolePanels = {
    ops: ['kpi-bridge-panel', 'device-starmap-panel', 'materials-radar-panel', 'command-center-panel'],
    biz: ['kpi-bridge-panel', 'realtime-flow-panel', 'menu-heatmap-panel'],
    eng: ['kpi-bridge-panel', 'device-starmap-panel', 'command-center-panel', 'realtime-flow-panel']
  };
  
  return rolePanels[role]?.includes(panelId) ?? true;
}

// Legacy compatibility functions
async function loadTrends() {
  try {
    const days = curRange === 'today' ? 1 : curRange === '30d' ? 30 : 7;
    const r = await fetch(`/api/v1/dashboard/trends?days=${days}`, {headers: hdr});
    const j = await r.json();
    // Update trend visualizations
  } catch(e) {
    console.error('Failed to load trends:', e);
  }
}

async function loadLow() {
  try {
    const r = await fetch('/api/v1/dashboard/low-materials?limit=10', {headers: hdr});
    const j = await r.json();
    // Update low materials display
  } catch(e) {
    console.error('Failed to load low materials:', e);
  }
}

async function loadOrdersKPI() {
  try {
    const range = getRange();
    const qs = new URLSearchParams({
      from: String(range.from),
      to: String(range.to)
    });
    const r = await fetch(`/api/v1/orders/stats?${qs}`, {headers: hdr});
    const j = await r.json();
    const d = j.data || {};
    
    updateKPI('kpi-orders', d.total_orders ?? '-');
    updateKPI('kpi-revenue', d.total_revenue ? `¥${(d.total_revenue/100).toFixed(2)}` : '-');
  } catch(e) {
    console.error('Failed to load orders KPI:', e);
  }
}

function exportSummary() {
  cmUI.toast('导出功能准备中...', 'info');
}

function resetRange() {
  setRange('7d');
  reloadAll();
}

function createNewBatch() {
  window.location.href = '/dispatch';
}

</script>

{% endblock %}
